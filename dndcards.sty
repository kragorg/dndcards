\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{dndcards}{2026/01/28}{1.0}{D&D Index Cards}

\RequirePackage[paperwidth=6in, paperheight=4in, margin=0.25in]{geometry}
\RequirePackage{pdflscape}
\RequirePackage{ETbb}
\RequirePackage{array}
\RequirePackage{booktabs}
\RequirePackage[skip=0em]{parskip}
\RequirePackage{totcount}
\RequirePackage{xcolor}
\RequirePackage{xspace}
\RequirePackage[perpage,para,bottom,norule,symbol*]{footmisc}

\RequirePackage[inline]{enumitem}
\setlist[itemize]{topsep=0em,partopsep=0em,parsep=0em,itemsep=0.5em}

\RequirePackage{tikz}
\RequirePackage{afterpage}
\ExplSyntaxOff
\usetikzlibrary{calc}
\ExplSyntaxOn

\definecolor{headercolor}{HTML}{8B2020}

% Error messages for footnote validation
\msg_new:nnn {dnd} {footnote-ref-undefined}
  { Footnote~reference~'#1'~used~before~definition }
\msg_new:nnn {dnd} {footnote-used-not-defined}
  { Footnote~'#1'~referenced~but~never~defined }
\msg_new:nnn {dnd} {footnote-text-mismatch}
  { Footnote~mismatch:~#1~marks~defined~but~#2~\token_to_str:N\ftext~calls }

% Error messages for resource validation
\msg_new:nnn {dnd} {resource-not-integer}
  { Resource~'#1'~count~'#2'~is~not~a~valid~integer }
\msg_new:nnn {dnd} {resource-count-invalid}
  { Resource~'#1'~count~#2~must~be~at~least~1 }

\seq_new:N \l__dndcards_inlinelist_items_seq

% Shared utility: Calculate D&D 5E ability modifier: (score - 10) / 2
% This is the core mathematical formula used by both character and monster systems
\cs_new:Nn \__dndcards_modifier:n {
    \int_eval:n {
        \int_if_odd:nTF {#1} { (#1 - 11) } { (#1 - 10) }
        / 2
    }
}

% Shared utility: Format modifier with +/- sign (3 → +3, -2 → -2, 0 → +0)
\cs_new:Nn \__dndcards_format_stat:n {
    \int_compare:nNnTF {#1} > { -1 } { +\int_eval:n{#1} } { \int_eval:n{#1} }
}
\cs_generate_variant:Nn \__dndcards_format_stat:n { e }

\NewDocumentCommand{\InlineList}{m}
  {
    \group_begin:
    \seq_set_from_clist:Nn \l__dndcards_inlinelist_items_seq {#1}
    \seq_use:Nnnn \l__dndcards_inlinelist_items_seq
      { ~and~ }
      { ,~ }
      { ,~and~ }
    \group_end:
  }

\NewDocumentCommand{\TitleCard}{O{}m}{
    \group_begin:
    \vspace*{\fill}
    \begin{center}
    \Huge \textcolor{headercolor}{\scshape #2} \par
    \tl_if_empty:nF {#1} {
        \Large #1 \par
    }
    \end{center}
    \vspace*{\fill}
    \newpage
    \group_end:
}

\NewDocumentCommand{\ThinRule}{}{\rule{\textwidth}{0.4pt}}

\cs_new_protected:Nn \__dndcards_header:nn {
  {
    \noindent
    \Large \bfseries \scshape \color{headercolor}
    #2
  }
  \tl_if_novalue:nF { #1 } {
     \hfill
     { \normalfont \small \itshape #1 }
  }
  \skip_gzero:N \parskip
  \par
  \noindent \ThinRule
  \__dndcards_add_continuation_arrow:
  \par
  \bool_gset_true:N \g__dndcards_restore_parskip_bool
}

\renewcommand{\footnoterule}{}

\int_new:N \g_fmark_count_int
\int_new:N \g_ftext_count_int

% Tracking sequences for footnote validation
\seq_new:N \g_dnd_fmark_defined_seq
\seq_new:N \g_dnd_fmark_used_seq
\cs_new_protected:Npn \fmark {
  \int_gincr:N \g_fmark_count_int
  \unskip
  \footnotemark[ \int_use:N \g_fmark_count_int ]
  \xspace
}
\cs_new_protected:Npn \ftext #1 {
  \int_gincr:N \g_ftext_count_int
  \footnotetext[ \int_use:N \g_ftext_count_int ] { #1 }
}
\cs_new_protected:Nn \__fmark_define:N
  {
    \fmark
    \int_gset:Nn #1 { \int_use:N \g_fmark_count_int }
    % Track this letter was defined
    \seq_gput_right:Nn \g_dnd_fmark_defined_seq
      { \cs_to_str:N #1 }
  }
\cs_new_protected:Nn \__fmark_use:N {
  % Check if this mark was defined
  \int_compare:nNnTF { #1 } = { 0 }
  {
    \msg_error:nnx {dnd} {footnote-ref-undefined}
      { \cs_to_str:N #1 }
  }
  {
    \unskip
    \footnotemark [ \int_use:N #1 ]
    \xspace
    % Track usage
    \seq_gput_right:Nn \g_dnd_fmark_used_seq
      { \cs_to_str:N #1 }
  }
}

\int_step_inline:nnn { `a } { `z } {
  \int_new:c { g_fmark_saved \char_generate:nn {#1} {11} _int }
  \cs_new:cpx { fmark \char_generate:nn { #1 - 32 } {11} } {
    \exp_not:N \__fmark_define:N
    \exp_not:c { g_fmark_saved \char_generate:nn {#1} {11} _int }
  }
  \cs_new:cpx { fmark \char_generate:nn {#1} {11} } {
    \exp_not:N \__fmark_use:N
    \exp_not:c { g_fmark_saved \char_generate:nn {#1} {11} _int }
  }
}

\tl_new:N \l__dndcards_saved_everypar_tl

\int_new:N \g__dndcards_cardno_int
\tl_new:N \g__dndcards_cardtitle_tl
\tl_new:N \g__dndcards_cardtags_tl
\tl_new:N \g__dndcards_cardcounter_tl
\bool_new:N \g__dndcards_in_starred_card_bool
\bool_new:N \g__dndcards_restore_parskip_bool
\AddToHook{para/begin}{
  \bool_if:NT \g__dndcards_restore_parskip_bool {
    \bool_gset_false:N \g__dndcards_restore_parskip_bool
    \skip_gset:Nn \parskip { 0.1in }
  }
}

\cs_new_protected:Nn \__dndcards_continuation_header:
{
  \bool_if:NT \g__dndcards_in_starred_card_bool
  {
    \tl_set:Nx \l_tmpa_tl { cardno \int_use:N \g__dndcards_cardno_int }
    \exp_args:NV \stepcounter \l_tmpa_tl
    \int_gset:Nn \g_fmark_count_int { 0 }
    \int_gset:Nn \g_ftext_count_int { 0 }
    \seq_gclear:N \g_dnd_fmark_defined_seq
    \seq_gclear:N \g_dnd_fmark_used_seq
    % Save and reset list paragraph shaping so header renders full-width
    \tl_set:Nx \l__dndcards_saved_everypar_tl { \tex_the:D \everypar }
    \everypar{}
    \parshape \c_zero_int
    \par\vspace{-\parskip}
    \__dndcards_header:nn
      {
        \g__dndcards_cardtags_tl
        \c_space_tl ( \exp_args:NV \arabic \l_tmpa_tl
        \c_space_tl of \c_space_tl
        \exp_args:NV \total \l_tmpa_tl )
      }
      { \g__dndcards_cardtitle_tl }
    % Immediately restore parskip for continuation pages.
    % Unlike the initial header (which uses para/begin hook), we restore here
    % because overflow content doesn't trigger para/begin, and we need parskip
    % to be 0.1in when the paragraph after overflow starts.
    \skip_gset:Nn \parskip { 0.1in }
    % Restore list paragraph shaping for subsequent content
    \everypar \exp_after:wN { \l__dndcards_saved_everypar_tl }
    \__dndcards_arm_continuation:
  }
}

\cs_new_protected:Nn \__dndcards_arm_continuation:
{
  \bool_if:NT \g__dndcards_in_starred_card_bool
  {
    \afterpage { \__dndcards_continuation_header: }
  }
}

% Add continuation arrow in bottom right corner (for all pages except the last)
\cs_new_protected:Nn \__dndcards_add_continuation_arrow:
{
  \bool_if:NT \g__dndcards_in_starred_card_bool
  {
    \tl_set:Nx \l_tmpa_tl { cardno \int_use:N \g__dndcards_cardno_int }
    % Check if current page < total pages
    \int_compare:nNnT
      { \value{\l_tmpa_tl} } < { \exp_args:NV \__dndcards_get_total:n \l_tmpa_tl }
    {
      % Add arrow in bottom margin using absolute positioning
      \begin{tikzpicture}[remember~picture, overlay]
        \node[anchor=south~east, inner~sep=0pt]
          at ($(current~page.south~east) + (-0.3in, 0.125in)$)
          { \textcolor{headercolor}{\Large$\rightarrow$} };
      \end{tikzpicture}
    }
  }
}

% Helper to get total count safely (returns 0 if counter doesn't exist yet)
\cs_new_protected:Nn \__dndcards_get_total:n
{
  \cs_if_exist:cTF { c@#1 }
    { \totvalue{#1} }
    { 0 }
}

% Helper to build and output card header with optional "(X of Y)" numbering
\cs_new_protected:Nn \__dndcards_header_counter:nn
{
  \exp_args:Nx \int_compare:nNnTF { \exp_args:NV \__dndcards_get_total:n \g__dndcards_cardcounter_tl } > { 1 }
  {
    \__dndcards_header:nn
      {
        #1 \c_space_tl (
        \exp_args:NV \arabic \g__dndcards_cardcounter_tl
        \c_space_tl of \c_space_tl
        \exp_args:NV \total \g__dndcards_cardcounter_tl
        )
      }
      { #2 }
  }
  {
    \__dndcards_header:nn { #1 } { #2 }
  }
}

\cs_new_protected:Npn \Newpage {
  \newpage \vspace{-\parskip}
}

\NewDocumentEnvironment{Card}{O{}m}{
  \setlength{\parskip}{0em}
  \int_gincr:N \g__dndcards_cardno_int
  \tl_gset:Nn \g__dndcards_cardtitle_tl { #2 }
  \tl_gset:Nn \g__dndcards_cardtags_tl { #1 }
  \tl_gset:Nx \g__dndcards_cardcounter_tl { cardno \int_use:N \g__dndcards_cardno_int }
  \exp_args:NV \newtotcounter \g__dndcards_cardcounter_tl
  \exp_args:NV \stepcounter \g__dndcards_cardcounter_tl
  \bool_gset_true:N \g__dndcards_in_starred_card_bool
  \__dndcards_arm_continuation:
  \int_gset:Nn \g_fmark_count_int 0
  \int_gset:Nn \g_ftext_count_int 0
  \seq_gclear:N \g_dnd_fmark_defined_seq
  \seq_gclear:N \g_dnd_fmark_used_seq
  \__dndcards_header_counter:nn { #1 } { #2 }
} {
  % Validate footnotes before ending card
  \seq_map_inline:Nn \g_dnd_fmark_used_seq {
    \seq_if_in:NnF \g_dnd_fmark_defined_seq {##1}
      { \msg_error:nnn {dnd} {footnote-used-not-defined} {##1} }
  }
  \int_compare:nNnF
    { \g_fmark_count_int } = { \g_ftext_count_int }
  {
    \msg_error:nnxx {dnd} {footnote-text-mismatch}
      { \int_use:N \g_fmark_count_int }
      { \int_use:N \g_ftext_count_int }
  }
  \bool_gset_false:N \g__dndcards_in_starred_card_bool
  \newpage
}

\NewDocumentCommand{\head}{m}{
  { \small \scshape \bfseries \textcolor{ headercolor }{ #1 } }
}

\NewDocumentCommand{\sect}{sm}{
  \IfBooleanF { #1 } { \vspace{1em} }
  { \centering \normalsize \scshape \bfseries
    \textcolor{ headercolor }{ #2 }
    \par }
}

\NewDocumentCommand{\freq}{m}{
  \footnotesize \textit{ #1 }
}

\dim_new:N \__dndcards_rtab_name_dim
\dim_new:N \__dndcards_rtab_boxes_dim

\NewDocumentEnvironment{ResourceTable}{}{
  \dim_set:Nn \__dndcards_rtab_name_dim { 0.26 \linewidth }
  \dim_set:Nn \__dndcards_rtab_boxes_dim { 0.14 \linewidth }
  \cs_set:Npn \header ##1 {
    \multicolumn{2}{
      >{ \centering\arraybackslash }
      p{ \dim_eval:n { \__dndcards_rtab_name_dim + \__dndcards_rtab_boxes_dim } }
    }{
      \head{ ##1 }
      \vspace{ 0.5em }
    }
  }
  \cs_set:Npn \resource ##1##2 {
    % Validate resource count
    \regex_match:nnF { ^\d+$ } {##2}
        { \msg_error:nnxx {dnd} {resource-not-integer} {##1} {##2} }
    \int_compare:nNnTF {##2} < {1}
        { \msg_error:nnxx {dnd} {resource-count-invalid} {##1} {##2} }
        {
            ##1
            &
            \int_step_inline:nn { ##2 } {
                \raisebox{-0.5ex}{
                    \tikz[baseline=0.1ex]{\draw[line~width=0.8pt, headercolor] (0,0) rectangle (0.4cm,0.4cm);}
                }
                \kern0.5em
            }
        }
  }
  \group_begin:
  \renewcommand{\arraystretch}{1.5}
  \centering
  \begin{tabular}{
    @{}
    >{ \raggedleft \arraybackslash}   p{\__dndcards_rtab_name_dim }
    >{ \raggedright \arraybackslash}  p{\__dndcards_rtab_boxes_dim }
    @{}
    >{ \raggedleft \arraybackslash}   p{\__dndcards_rtab_name_dim }
    >{ \raggedright \arraybackslash}  p{\__dndcards_rtab_boxes_dim }
    @{}
    @{}
  }
} {
  \end{tabular}
  \group_end:
}
